# Исправление синхронизации монет и уровней

## Проблема
Монеты и уровни на главной странице и в профиле показывали разные значения:
- Главная страница: использовала значения из колонок `user_profiles.coins/level`
- Профиль: вычислял значения динамически из `task_logs`

## Решение

### 1. Обновлен тип UserProfile
Добавлены игровые поля в `lib/auth.ts`:
```typescript
export type UserProfile = {
  // ... существующие поля
  // Игровые поля
  coins?: number
  experience?: number
  level?: number
  achievements?: any[]
  last_activity?: string
  // ...
}
```

### 2. Добавлена функция расчета игровых статистик
В `lib/auth.ts` добавлена функция `calculateGameStats()`, которая:
- Получает `employee_id` из `user_profiles`
- Загружает все `task_logs` пользователя
- Рассчитывает общие монеты по формуле: `units_completed * GAME_CONFIG.TASK_REWARDS[task_name]`
- Вычисляет уровень через `calculateLevel(totalCoins)`

### 3. Обновлена загрузка профиля
Функция `getUserProfile()` теперь:
- Вызывает `calculateGameStats()` для получения реальных значений
- Добавляет рассчитанные `coins`, `experience`, `level` в профиль
- Возвращает профиль с актуальными игровыми данными

### 4. Упрощена главная страница
Функция `fetchPlayerCoins()` теперь:
- Использует `profile.coins` вместо вычисления из `task_logs`
- Устанавливает монеты сразу при загрузке профиля

## SQL скрипты для выполнения

### 1. Добавление игровых колонок (если не выполнено)
```sql
-- Выполните в Supabase SQL Editor
-- Содержимое файла: add-game-columns-to-user-profiles.sql
```

### 2. Синхронизация существующих данных
```sql
-- Выполните в Supabase SQL Editor
-- Содержимое файла: sync-game-stats-to-db.sql
```

## Результат

✅ **Единая система монет и уровней:**
- Главная страница и профиль показывают одинаковые значения
- Данные рассчитываются динамически из `task_logs`
- Кэширование для производительности

✅ **Реальные игровые статистики:**
- Монеты: рассчитываются по фактическим задачам
- Уровень: определяется по количеству монет
- Опыт: равен количеству монет

✅ **Производительность:**
- Расчет происходит при загрузке профиля
- Результаты кэшируются в памяти
- Нет дублирования запросов

## Проверка работы

1. Откройте главную страницу - должны отображаться актуальные монеты
2. Перейдите в профиль - монеты и уровень должны совпадать
3. Проверьте лидерборд - все пользователи должны иметь корректные значения

## Техническая информация

**Измененные файлы:**
- `lib/auth.ts` - добавлен тип и функция расчета
- `app/page.tsx` - упрощена логика загрузки монет
- `add-game-columns-to-user-profiles.sql` - добавление колонок
- `sync-game-stats-to-db.sql` - синхронизация данных

**Новые возможности:**
- Единый источник истины для игровых данных
- Автоматический расчет при каждой загрузке профиля
- Возможность легкого изменения формул расчета 