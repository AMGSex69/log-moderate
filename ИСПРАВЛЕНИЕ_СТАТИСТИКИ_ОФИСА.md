# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –æ—Ñ–∏—Å–∞

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å–º–µ–Ω–µ –æ—Ñ–∏—Å–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –ø–æ —Å—Ç–∞—Ä–æ–º—É –æ—Ñ–∏—Å—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–∞—Å—Å–≤–µ—Ç"), –∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ñ–∏—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¢—É–ª—å—Å–∫–∞—è"). –≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–ª–∞—Å—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.

## –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

1. **–•–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞**: –í —Ñ—É–Ω–∫—Ü–∏–∏ `fetchLeaderboard` –±—ã–ª —Ö–∞—Ä–¥–∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ—Ñ–∏—Å–∞ "–†–∞—Å—Å–≤–µ—Ç"
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**: –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ñ–∏—Å–∞
3. **–ù–µ–ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–∏ —Å–º–µ–Ω–µ –æ—Ñ–∏—Å–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ (`app/page.tsx`)

**–ë—ã–ª–æ:**
```javascript
// –•–∞—Ä–¥–∫–æ–¥ –¥–ª—è –æ—Ñ–∏—Å–∞ "–†–∞—Å—Å–≤–µ—Ç"
const { data: rassveetOffice } = await supabase
    .from("offices")
    .select("id")
    .eq("name", "–†–∞—Å—Å–≤–µ—Ç")
    .single()
```

**–°—Ç–∞–ª–æ:**
```javascript
// –ü–æ–ª—É—á–∞–µ–º –æ—Ñ–∏—Å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let userOfficeId = 1 // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ñ–∏—Å "–†–∞—Å—Å–≤–µ—Ç"

if (user) {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ user_profiles
    const { data: userProfile } = await supabase
        .from("user_profiles")
        .select("office_id")
        .eq("id", user.id)
        .maybeSingle()

    if (userProfile?.office_id) {
        userOfficeId = userProfile.office_id
    } else {
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ user_profiles, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ employees
        const { data: employee } = await supabase
            .from("employees")
            .select("office_id")
            .eq("user_id", user.id)
            .maybeSingle()
        
        if (employee?.office_id) {
            userOfficeId = employee.office_id
        }
    }
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ñ–∏—Å–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è (`app/profile/page.tsx`)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```javascript
// –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Å, –æ–±–Ω–æ–≤–ª—è–µ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—Ñ–∏—Å–∞
if (updateData.office_name) {
    console.log("üè¢ [–û–ë–ù–û–í–õ–ï–ù–ò–ï] –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—Ñ–∏—Å–∞...")
    await fetchOfficeStats()
    console.log("‚úÖ [–û–ë–ù–û–í–õ–ï–ù–ò–ï] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ñ–∏—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
}
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –æ—Ñ–∏—Å–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (`app/page.tsx`)

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `handleDistrictSelect`:**
```javascript
// –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ñ–∏—Å–∞
await fetchLeaderboard()

// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ñ–∏—Å–∞
refreshUserData()
```

### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ñ–∏—Å–∞ (`update-user-office.sql`)

**–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è SQL —Ñ—É–Ω–∫—Ü–∏—è:**
```sql
CREATE OR REPLACE FUNCTION update_user_office(
    user_uuid UUID,
    new_office_id INTEGER
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    office_exists BOOLEAN := FALSE;
BEGIN
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ñ–∏—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    SELECT EXISTS(SELECT 1 FROM offices WHERE id = new_office_id) INTO office_exists;
    
    IF NOT office_exists THEN
        RAISE EXCEPTION '–û—Ñ–∏—Å —Å ID % –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', new_office_id;
    END IF;
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤ user_profiles (–º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
    UPDATE user_profiles 
    SET 
        office_id = new_office_id,
        updated_at = NOW()
    WHERE id = user_uuid;
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤ employees (–º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
    UPDATE employees 
    SET 
        office_id = new_office_id,
        updated_at = NOW()
    WHERE user_id = user_uuid;
    
    -- –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        -- –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º FALSE
        RAISE NOTICE '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ñ–∏—Å–∞: %', SQLERRM;
        RETURN FALSE;
END;
$$;
```

### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- "–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –†–∞—Å—Å–≤–µ—Ç–∞" ‚Üí "–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ñ–∏—Å–∞"
- –õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ office_id

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. ‚úÖ –ü—Ä–∏ —Å–º–µ–Ω–µ –æ—Ñ–∏—Å–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
2. ‚úÖ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –æ—Ñ–∏—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ñ–∏—Å–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –æ—Ñ–∏—Å–∞
4. ‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥—ã
5. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Å–∞ –≤ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –ë–î

## –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã

1. `app/page.tsx` - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ –∏ —Å–º–µ–Ω—ã –æ—Ñ–∏—Å–∞
2. `app/profile/page.tsx` - –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ñ–∏—Å–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
3. `update-user-office.sql` - –ù–æ–≤–∞—è SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ñ–∏—Å–∞

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –ó–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å –∏ —Å–º–µ–Ω–∏—Ç–µ –æ—Ñ–∏—Å —Å "–†–∞—Å—Å–≤–µ—Ç" –Ω–∞ "–¢—É–ª—å—Å–∫–∞—è"
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ñ–∏—Å–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –æ—Ñ–∏—Å—É "–¢—É–ª—å—Å–∫–∞—è"
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –æ—Ñ–∏—Å–∞ "–¢—É–ª—å—Å–∫–∞—è" 