# ‚úÖ –†–ï–®–ï–ù–ò–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–æ–Ω–µ—Ç –∏ —É—Ä–æ–≤–Ω–µ–π

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Ä–µ—à–µ–Ω–∞!

–ú–æ–Ω–µ—Ç—ã –∏ —É—Ä–æ–≤–Ω–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**.

---

## üîß –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–û–±–Ω–æ–≤–ª–µ–Ω —Ç–∏–ø UserProfile**
```typescript
// lib/auth.ts
export type UserProfile = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  // –ò–≥—Ä–æ–≤—ã–µ –ø–æ–ª—è
  coins?: number
  experience?: number  
  level?: number
  achievements?: any[]
  last_activity?: string
  // ...
}
```

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏–≥—Ä–æ–≤—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫**
```typescript
// lib/auth.ts
async calculateGameStats(userId: string): Promise<{ coins: number; experience: number; level: number }> {
  // –ü–æ–ª—É—á–∞–µ—Ç employee_id –∏–∑ user_profiles
  // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ task_logs –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã –ø–æ —Ñ–æ—Ä–º—É–ª–µ: units_completed * GAME_CONFIG.TASK_REWARDS[task_name]
  // –í—ã—á–∏—Å–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —á–µ—Ä–µ–∑ calculateLevel(totalCoins)
}
```

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è**
```typescript
// lib/auth.ts - getUserProfile()
// –¢–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç calculateGameStats() –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å
const gameStats = await this.calculateGameStats(userId)
const finalProfile = {
  ...userProfile,
  coins: gameStats.coins,
  experience: gameStats.experience,
  level: gameStats.level,
  // ...
}
```

### 4. **–£–ø—Ä–æ—â–µ–Ω–∞ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**
```typescript
// app/page.tsx - fetchPlayerCoins()
// –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç profile.coins –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
const coins = profile.coins || 0
setPlayerCoins(coins)
```

### 5. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ RPC –∏ –∫–æ–ª–æ–Ω–æ–∫**
```typescript
// app/profile/page.tsx - fetchOfficeStats()
// ‚úÖ –ó–∞–º–µ–Ω–µ–Ω –≤—ã–∑–æ–≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π get_office_statistics –Ω–∞ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ user_profiles
// ‚úÖ –£–±—Ä–∞–Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ–ª–æ–Ω–∫–∞ is_online –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
const { data: officeEmployees } = await supabase
  .from("user_profiles")
  .select("id, employee_id") // –£–±—Ä–∞–Ω–∞ is_online
  .eq("office_id", userProfile.office_id)
  .not("employee_id", "is", null)
```

---

## üìã SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
```sql
-- –§–∞–π–ª: add-game-columns-to-user-profiles.sql
-- –î–æ–±–∞–≤–ª—è–µ—Ç coins, experience, level, achievements, last_activity –≤ user_profiles
```

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö  
```sql
-- –§–∞–π–ª: sync-game-stats-to-db.sql
-- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ user_profiles
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### **–ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–µ—Ç –∏ —É—Ä–æ–≤–Ω–µ–π:**
- ‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `task_logs` 
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **–†–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ –ú–æ–Ω–µ—Ç—ã: —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞—á–∞–º –∏–∑ `task_logs`
- ‚úÖ –£—Ä–æ–≤–µ–Ω—å: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–æ–Ω–µ—Ç —á–µ—Ä–µ–∑ `calculateLevel()`
- ‚úÖ –û–ø—ã—Ç: —Ä–∞–≤–µ–Ω –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–æ–Ω–µ—Ç (–ø—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞)

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –æ—à–∏–±–∫–∏:**
- ‚úÖ –£–±—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∞ 404 –¥–ª—è `get_office_statistics` 
- ‚úÖ –£–±—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∞ 400 –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–ª–æ–Ω–∫–∏ `is_online`
- ‚úÖ –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ `employees`
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å `user_profiles`

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –†–∞—Å—á–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É** - –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã
2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å** - –º–æ–Ω–µ—Ç—ã –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –≥–ª–∞–≤–Ω–æ–π
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ 404/400
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥** - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- ‚úÖ `lib/auth.ts` - –¥–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø –∏ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
- ‚úÖ `app/page.tsx` - —É–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–Ω–µ—Ç  
- ‚úÖ `app/profile/page.tsx` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ fetchOfficeStats –∏ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- ‚úÖ `add-game-columns-to-user-profiles.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
- ‚úÖ `sync-game-stats-to-db.sql` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üéÆ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç** –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è  
- **–õ–µ–≥–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ** —Ñ–æ—Ä–º—É–ª —Ä–∞—Å—á–µ—Ç–∞ –º–æ–Ω–µ—Ç –∏ —É—Ä–æ–≤–Ω–µ–π
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞** –∏–≥—Ä–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–µ—Ç –∏ —É—Ä–æ–≤–Ω–µ–π —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–µ–∑–¥–µ, –∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞! 