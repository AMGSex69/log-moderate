# Исправление проблем с сохранением профиля и аватара

## Проблема
Не сохраняются изменения профиля, включая аватарку. В логах видно ошибки 400 при обращении к таблицам `user_profiles` и `employees`.

## Причина
Проблема связана с:
1. Отсутствующими RLS (Row Level Security) политиками
2. Неправильными запросами к базе данных
3. Отсутствующими записями в таблице `user_profiles`

## Решение

### Шаг 1: Исправление базы данных
Выполните SQL скрипты в Supabase SQL Editor в следующем порядке:

1. **Первый запуск: Добавление столбца avatar_url и настройка storage**
```bash
# Файл: fix-avatar-column.sql
```

2. **Второй запуск: Исправление RLS политик**
```bash
# Файл: fix-profile-policies.sql
```

### Шаг 2: Диагностика (опционально)
Для проверки структуры таблиц выполните:
```bash
# Файл: debug-tables.sql
```

### Шаг 3: Перезапуск приложения
После выполнения SQL скриптов перезапустите приложение:
```bash
npm run dev
```

## Что было исправлено в коде

### 1. authService.updateProfile (`lib/auth.ts`)
- Добавлена детальная отладка
- Улучшена обработка ошибок
- Добавлено автоматическое создание записи профиля если её нет
- Исправлена очистка undefined значений

### 2. handleSaveProfile (`app/profile/page.tsx`)
- Улучшена обработка данных аватара
- Добавлены проверки на пустые значения
- Улучшены сообщения об ошибках
- Убрано дублирование обновления аватара

### 3. Компонент загрузки аватара (`components/avatar-upload-with-crop.tsx`)
- Добавлена поддержка кропа изображений
- Улучшена загрузка в Supabase Storage
- Добавлены валидации размера и типа файлов

## Структура таблиц

### user_profiles
```sql
- id (uuid, PRIMARY KEY)
- full_name (text)
- position (text)
- is_admin (boolean)
- work_schedule (text)
- work_hours (integer)
- is_online (boolean)
- last_seen (timestamp)
- avatar_url (text) -- НОВЫЙ СТОЛБЕЦ
- created_at (timestamp)
- updated_at (timestamp)
- office_id (integer, FK to offices)
```

### employees
```sql
- id (integer, PRIMARY KEY)
- user_id (uuid, FK to auth.users)
- full_name (text)
- position (text)
- work_schedule (text)
- work_hours (integer)
- is_online (boolean)
- last_seen (timestamp)
- avatar_url (text)
- office_id (integer, FK to offices)
- created_at (timestamp)
- updated_at (timestamp)
```

## RLS Политики

### user_profiles
- Пользователи могут просматривать свой профиль
- Пользователи могут обновлять свой профиль
- Пользователи могут создавать свой профиль
- Админы могут управлять всеми профилями

### employees
- Пользователи могут просматривать свою запись
- Пользователи могут обновлять свою запись
- Админы могут управлять всеми записями

## Storage настройки

### Bucket: avatars
- Публичный доступ: да
- Максимальный размер файла: 2MB
- Разрешенные типы: image/jpeg, image/png, image/gif, image/webp

### Политики Storage
- Аутентифицированные пользователи могут загружать аватары
- Все могут просматривать аватары
- Пользователи могут удалять/обновлять свои аватары

## Проверка работы

1. Откройте профиль
2. Измените данные профиля
3. Загрузите аватар
4. Нажмите "Сохранить"
5. Проверьте консоль на наличие детальных логов

В случае ошибок проверьте:
- Выполнены ли все SQL скрипты
- Подключение к правильной базе данных Supabase
- Правильность переменных окружения NEXT_PUBLIC_SUPABASE_* 