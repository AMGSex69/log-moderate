# üè¢üëë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Ä–æ–ª–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### üéØ **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è:**

1. **üëë –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω** (`super_admin`)
   - –î–æ—Å—Ç—É–ø –∫–æ –í–°–ï–ú —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –í–°–ï–• –æ—Ñ–∏—Å–æ–≤
   - –ú–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å –ª—é–±—ã–µ —Ä–æ–ª–∏ (–≤–∫–ª—é—á–∞—è –¥—Ä—É–≥–∏—Ö —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤)
   - –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –≤—Å–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

2. **üè¢ –û—Ñ–∏—Å-–∞–¥–º–∏–Ω** (`office_admin`) 
   - –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –°–í–û–ï–ì–û –æ—Ñ–∏—Å–∞
   - –ú–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ä–æ–ª–∏: `user`, `office_admin` (–Ω–æ –Ω–µ `super_admin`)
   - –í–∏–¥–∏—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Ç–æ–ª—å–∫–æ –ø–æ —Å–≤–æ–µ–º—É –æ—Ñ–∏—Å—É

3. **üë§ –û–±—ã—á–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫** (`user`)
   - –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é
   - –ù–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:

### 1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**

```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:
```

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
-- sql/add-admin-roles-system.sql
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'user_profiles' 
AND column_name IN ('admin_role', 'managed_office_id');

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞
SELECT full_name, admin_role, is_admin 
FROM user_profiles up
JOIN auth.users au ON au.id = up.id
WHERE au.email = 'egordolgih@mail.ru';
```

### 3. **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**

```bash
vercel --prod
```

## üéÆ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

### üëë **–î–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞:**
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **–°–û–¢–†–£–î–ù–ò–ö–ò** –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
2. –í–∏–¥–µ—Ç—å –í–°–ï–• —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤—Å–µ—Ö –æ—Ñ–∏—Å–æ–≤
3. –ò–∑–º–µ–Ω—è—Ç—å –æ—Ñ–∏—Å—ã –∏ —Ä–æ–ª–∏ –ª—é–±—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
4. –ù–∞–∑–Ω–∞—á–∞—Ç—å –æ—Ñ–∏—Å-–∞–¥–º–∏–Ω–æ–≤ –∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤

### üè¢ **–î–ª—è –æ—Ñ–∏—Å-–∞–¥–º–∏–Ω–∞:**
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **–°–û–¢–†–£–î–ù–ò–ö–ò** –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏  
2. –í–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –°–í–û–ï–ì–û –æ—Ñ–∏—Å–∞
3. –ò–∑–º–µ–Ω—è—Ç—å –æ—Ñ–∏—Å—ã –∏ —Ä–æ–ª–∏ (–∫—Ä–æ–º–µ super_admin)
4. –ù–∞–∑–Ω–∞—á–∞—Ç—å –æ—Ñ–∏—Å-–∞–¥–º–∏–Ω–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–≥–æ –æ—Ñ–∏—Å–∞

### üë§ **–î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:**
- –†–∞–∑–¥–µ–ª **–°–û–¢–†–£–î–ù–ò–ö–ò** –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é

## üîß –§—É–Ω–∫—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

### `check_admin_access(user_uuid)`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```sql
SELECT * FROM check_admin_access('user-uuid-here');
```

### `get_employees_for_admin(user_uuid)`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∞–º:
```sql
SELECT * FROM get_employees_for_admin('user-uuid-here');
```

### `update_employee_permissions(requesting_uuid, target_uuid, office_id, role, managed_office)`
–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
```sql
SELECT update_employee_permissions(
    'admin-uuid',
    'employee-uuid', 
    1, -- –Ω–æ–≤—ã–π –æ—Ñ–∏—Å
    'office_admin', -- –Ω–æ–≤–∞—è —Ä–æ–ª—å
    1 -- —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –æ—Ñ–∏—Å
);
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- **–§—É–Ω–∫—Ü–∏–∏ SECURITY DEFINER** –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- **–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤** –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–æ–ª–µ–π** —á–µ—Ä–µ–∑ CHECK constraints

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ–ª–µ–π:

```
üëë SUPER_ADMIN (egordolgih@mail.ru)
‚îú‚îÄ‚îÄ üè¢ OFFICE_ADMIN (–†–∞—Å—Å–≤–µ—Ç)
‚îÇ   ‚îú‚îÄ‚îÄ üë§ USER (–°–æ—Ç—Ä—É–¥–Ω–∏–∫ 1)
‚îÇ   ‚îî‚îÄ‚îÄ üë§ USER (–°–æ—Ç—Ä—É–¥–Ω–∏–∫ 2)
‚îú‚îÄ‚îÄ üè¢ OFFICE_ADMIN (–ë—É–¥–∞–ø–µ—à—Ç)  
‚îÇ   ‚îú‚îÄ‚îÄ üë§ USER (–°–æ—Ç—Ä—É–¥–Ω–∏–∫ 3)
‚îÇ   ‚îî‚îÄ‚îÄ üë§ USER (–°–æ—Ç—Ä—É–¥–Ω–∏–∫ 4)
‚îî‚îÄ‚îÄ ... –¥—Ä—É–≥–∏–µ –æ—Ñ–∏—Å—ã
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫:

- [ ] SQL —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- [ ] –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è egordolgih@mail.ru
- [ ] –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—ã
- [ ] –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ
- [ ] –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–°–û–¢–†–£–î–ù–ò–ö–ò" –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- [ ] –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —É –≤–∞—Å –±—É–¥–µ—Ç:

1. **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞–¥–º–∏–Ω–∫–∞** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø—Ä–∞–≤
2. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏** –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ª–µ–∑—Ç—å –≤ –ë–î
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ä–æ–ª–µ–π

üéÆ **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéÆ 