# Исправление автоматического закрытия активных задач

## Описание проблемы

При автоматическом сбросе рабочего дня в 00:00 активные задачи оставались включенными. Это приводило к тому, что:

1. ✅ Рабочий день автоматически сбрасывался
2. ❌ Активные задачи оставались запущенными
3. ❌ Таймеры продолжали работать
4. ❌ Статистика могла искажаться

## Решение

Создан улучшенный скрипт `auto-close-workday-with-tasks.sql`, который:

### 1. **Автоматически закрывает активные задачи**
```sql
UPDATE active_sessions 
SET 
    is_active = false,
    last_heartbeat = NOW()
WHERE 
    is_active = true 
    AND DATE(started_at) < CURRENT_DATE;
```

### 2. **Закрывает незавершенные рабочие дни**
- Если пришли до 18:00 → закрывает в 18:00
- Если пришли после 18:00 → добавляет 8 часов работы

### 3. **Сбрасывает статус онлайн**
```sql
UPDATE employees 
SET is_online = false, updated_at = NOW()
WHERE is_online = true;
```

### 4. **Очищает старые данные**
- Удаляет активные сессии старше 7 дней
- Предотвращает накопление мусорных данных

## Как применить исправление

### Вариант 1: Выполнить скрипт вручную
1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Выполните содержимое файла `auto-close-workday-with-tasks.sql`

### Вариант 2: Использовать функцию
```sql
-- Создает функцию для автоматического вызова
SELECT auto_close_workday_and_tasks();
```

## Как настроить автоматический запуск

### Для Supabase (pg_cron)
```sql
-- Добавляем задачу в cron для ежедневного выполнения в 00:00
SELECT cron.schedule('auto-close-workday', '0 0 * * *', 'SELECT auto_close_workday_and_tasks();');
```

### Альтернативы
1. **Vercel Cron Jobs** - через vercel.json
2. **GitHub Actions** - через workflow
3. **Внешний сервис** - через webhook

## Что происходит при выполнении

### ✅ Что закрывается автоматически:
- Рабочие дни предыдущих дней без `clock_out_time`
- Активные задачи (`active_sessions`) предыдущих дней
- Статус онлайн всех сотрудников

### ✅ Что сохраняется:
- Активные задачи текущего дня
- Статистика выполненных задач
- История работы

### ✅ Что очищается:
- Старые активные сессии (>7 дней)

## Диагностика

Скрипт показывает подробные отчеты:

1. **Закрытые активные задачи**
   - Имя сотрудника
   - Название задачи  
   - Время запуска
   - Статус

2. **Закрытые рабочие дни**
   - Время прихода/ухода
   - Количество минут работы
   - Статус закрытия

3. **Общая статистика**
   - Количество закрытых дней
   - Количество деактивированных задач
   - Оставшиеся активные задачи

## Пример результата

```
Общая статистика очистки:
┌─────────────────────────┬───────┐
│ metric                  │ count │
├─────────────────────────┼───────┤
│ Закрыто рабочих дней    │   3   │
│ Деактивировано задач    │   7   │
│ Активных задач на сегодня│   2   │
└─────────────────────────┴───────┘
```

## Проверка корректности

После выполнения скрипта проверьте:

1. **Нет старых активных задач**:
   ```sql
   SELECT COUNT(*) FROM active_sessions 
   WHERE is_active = true AND DATE(started_at) < CURRENT_DATE;
   -- Должно быть 0
   ```

2. **Нет незакрытых рабочих дней**:
   ```sql
   SELECT COUNT(*) FROM work_sessions 
   WHERE date < CURRENT_DATE 
   AND clock_in_time IS NOT NULL 
   AND clock_out_time IS NULL;
   -- Должно быть 0
   ```

## Безопасность

✅ **Безопасно выполнять**:
- Не удаляет данные, только обновляет статусы
- Сохраняет всю историю
- Обрабатывает только предыдущие дни

✅ **Можно повторно запускать**:
- Идемпотентные операции
- Не создает дубликатов
- Безопасно при повторном выполнении

## Интеграция с приложением

После применения этого исправления:

1. ✅ Пользователи не увидят "зависшие" задачи при входе утром
2. ✅ Статистика будет корректной
3. ✅ Таймеры начнут с чистого листа
4. ✅ Нет необходимости вручную закрывать старые задачи

## Мониторинг

Рекомендуется добавить логирование:

```sql
-- Для отслеживания работы автозакрытия
CREATE TABLE IF NOT EXISTS auto_close_logs (
    id SERIAL PRIMARY KEY,
    executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    closed_workdays INTEGER,
    closed_tasks INTEGER,
    result_message TEXT
);
```

---

**Статус**: ✅ Готово к применению  
**Приоритет**: Высокий  
**Влияние**: Исправляет критическую проблему с "зависшими" задачами 