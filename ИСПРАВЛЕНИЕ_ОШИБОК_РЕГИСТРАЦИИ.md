# Исправление ошибок регистрации (500 Internal Server Error)

## Проблема
При попытке регистрации новых пользователей возникает ошибка:
```
POST https://qodmtekryabmcnuvvbyf.supabase.co/auth/v1/signup 500 (Internal Server Error)
```

## Причины ошибки 500

Ошибка 500 обычно связана с:
1. **Проблемы с базой данных** - отсутствующие таблицы или неправильные RLS политики
2. **Ошибки в триггерах** - функции базы данных которые выполняются при создании пользователя
3. **Неправильная конфигурация аутентификации** в Supabase
4. **Превышение лимитов** Supabase

## Шаги для исправления

### 1. Выполните SQL скрипт исправления

Откройте **Supabase Dashboard** → **SQL Editor** и выполните скрипт `fix-auth-registration.sql`:

```bash
# Файл уже создан в проекте
cat fix-auth-registration.sql
```

Этот скрипт:
- ✅ Создает необходимые таблицы `user_profiles` и `employees`  
- ✅ Настраивает безопасные RLS политики
- ✅ Создает триггеры для автоматического создания профилей
- ✅ Добавляет обработку ошибок в функции

### 2. Проверьте настройки аутентификации

В **Supabase Dashboard** → **Authentication** → **Settings**:

1. **Enable email confirmations** - ❌ ВЫКЛЮЧИТЕ для тестирования
2. **Disable new user signups** - ❌ ДОЛЖНО БЫТЬ ВЫКЛЮЧЕНО  
3. **Enable phone confirmations** - ❌ ВЫКЛЮЧИТЕ
4. **Email confirmation URL** - должен указывать на ваш сайт

### 3. Проверьте RLS политики

В **Database** → **Tables** убедитесь что:
- ✅ `user_profiles` имеет RLS политики для SELECT, INSERT, UPDATE
- ✅ `employees` имеет RLS политики для SELECT, INSERT  
- ✅ `task_types` доступна для чтения всем пользователям
- ✅ `task_logs` имеет соответствующие политики

### 4. Проверьте логи ошибок

В **Supabase Dashboard** → **Logs** посмотрите:
- **Auth logs** - ошибки аутентификации
- **Database logs** - ошибки SQL запросов  
- **Edge Function logs** - если используются

## Тестирование исправлений

### 1. Попробуйте зарегистрироваться
```bash
# Запустите приложение
npm run dev

# Перейдите в браузере
http://localhost:3000

# Нажмите "Регистрация"
# Заполните форму:
# - Имя: Тест Тестов
# - Email: test@example.com  
# - Пароль: 123456
# - График: 8+1
```

### 2. Проверьте консоль браузера
- ❌ НЕ должно быть ошибок 500
- ✅ Должно показать "Регистрация успешна!"
- ✅ Пользователь должен автоматически войти в систему

### 3. Проверьте базу данных
В **Supabase Dashboard** → **Table Editor**:
- ✅ В `auth.users` должна появиться новая запись
- ✅ В `user_profiles` должен быть создан профиль
- ✅ В `employees` должна быть создана запись сотрудника

## Расширенная диагностика

### Если ошибка 500 продолжается:

1. **Проверьте лимиты**:
   ```
   Supabase Dashboard → Settings → Billing
   - Database size
   - API requests  
   - Authentication users
   ```

2. **Проверьте триггеры**:
   ```sql
   SELECT * FROM information_schema.triggers 
   WHERE trigger_name LIKE 'on_%user%';
   ```

3. **Проверьте функции**:
   ```sql
   SELECT proname, prosrc FROM pg_proc 
   WHERE proname LIKE 'handle_new_%';
   ```

4. **Временно отключите триггеры** для тестирования:
   ```sql
   DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
   DROP TRIGGER IF EXISTS on_user_profile_created ON public.user_profiles;
   ```

## Альтернативные решения

### Если проблема не решается:

1. **Создайте новый проект Supabase** с чистой конфигурацией
2. **Используйте backup данных** если есть
3. **Обратитесь в поддержку Supabase** с деталями ошибки

## Улучшения в коде

Добавлена лучшая обработка ошибок в форме регистрации:
- ✅ Понятные сообщения для ошибки 500
- ✅ Логирование ошибок в консоль для отладки  
- ✅ Обработка специфичных случаев (rate limits, существующий user)

## Проверка статуса

После исправлений проверьте:
- [ ] SQL скрипт выполнен без ошибок
- [ ] Настройки аутентификации корректны
- [ ] Регистрация работает без ошибок 500
- [ ] Профили создаются автоматически
- [ ] Пользователи могут войти в систему

---

**Важно**: Если используете production, обязательно включите email confirmations обратно после тестирования! 